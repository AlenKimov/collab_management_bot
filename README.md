# Collab Management Telegram Bot
Телеграм бот для коллаб-менеджеров.

## Терминология
- **TSS** — TweetScout Score.
- **Представитель** — человек, представляющий интересы проекта (чаще всего это коллаб-менеджер или администратор).
- **Оценка** — лайк или дизлайк.

## База данных
Описание таблиц и логики базы данных.

- База данных обязана делать резервное копирование, чтобы в случае непредвиденных обстоятельств можно было откатиться.

[**manager**] Таблица с данными о менеджерах

| Поле                           | Описание                        |
| ------------------------------ | ------------------------------- |
| _telegram_id_ (Первичный ключ) | Telegram ID                     |
| _telegram_handle_              | Telegram Handle                 | 
| _created_at_                   | Дата и время внесения в таблицу |
| _is_admin_                     | Является ли администратором     |

- При удалении менеджера (**manager**) также должны удаляться все относящиеся к нему записи из таблицы оценок (**vote**).

[**project**] Таблица с данными о проектах

| Поле                                     | Описание                              |
| ---------------------------------------- | ------------------------------------- |
| _twitter_handle_ (Первичный ключ)        | Twitter Handle                        |
| _created_at_                             | Дата и время внесения в таблицу       |
| _discord_url_                            | Ссылка на дискорд проекта             |
| _discord_admin_nickname_                 | Имя пользователя админа дискорда      |
| _tss_                                    | TSS (TweetScout Score)                |
| _**manager**.telegram_id_ (Внешний ключ) | Telegram ID ведущего проект менеджера |
| _likes_                                  | Количество лайков                     |
| _dislikes_                               | Количество дизлайков                  |

- При удалении проекта (**project**) также должны удаляться все относящиеся к нему записи из таблицы (**vote**).
- _twitter_handle_ должен быть либо нечувствительным к регистру, либо только в определенном (нижнем) регистре.

[**vote**] Таблица с оценками (лайками и дизлайками)

| Поле                                        | Описание                 |
| ------------------------------------------- | ------------------------ |
| _**manager**.telegram_id_ (Внешний ключ)    | Telegram ID менеджера    |
| _**project**.twitter_handle_ (Внешний ключ) | Twiiter Handle проекта   |
| _vote_type_                                 | Оценка: лайк или дизлайк |

- При внесении в таблицу новой оценки (**vote**) счетчик лайков (_**project**.likes_) или дизлайков (_**project**.dislikes_) проекта должен инкрементироваться (увеличиваться на один). При удалении, наоборот — декрементироваться (уменьшаться на один).

## Доступные форматы ссылок на твиттер
Доступные форматы ссылки на твиттер:
```
https://twitter.com/elonmusk
https://twitter.com/@elonmusk
https://twitter.com/elonmusk?lang=en
https://twitter.com/@elonmusk?lang=en
@elonmusk
elonmusk
```

- Длина Twitter Handle без @ не может превышать 15 символов.

## Менеджер
### Роли
Существует три роли: пользователь, менеджер и администратор.

Роль менеджера пользователю можно назначить с помощью команды `/add_manager`, доступной только администраторам.

Роль администратора можно назначить только напрямую через базу данных установкой флага _is_admin_ в состояние _True_.

### Формат вывода информации о менеджере
Формат вывода информации о менеджере включает в себя следующую информацию:
- Роль менеджера.
- Telegram Handle менеджера.
- Telegram ID менеджера.

Вся информация умещается в одну строчку.

Пример вывода информации о менеджере:
```
# ┏━ Роль
# ┃      ┏━ Telegram Handle
# ┃      ┃          ┏━ Telegram ID
[Admin] @AlenKimov (123456789)
```

## Команды бота
Команды для обычных пользователей (не менеджеров):
- `/start` — содержит в себе приветственное сообщение и инструкцию, как стать менеджером.
- `/help` — содержит в себе инструкцию, как стать менеджером.
- Если пользователь попробует ввести команду для менеджеров, выведется сообщение с информацией о том, что это команда доступна только менеджерам, и с отсылкой на команду `/help`. 

Команды для менеджеров:
- `/help` — содержит в себе описания всех команд для менеджеров.
- `/my` (`/me`) — выводит список всех взятых менеджером проектов, отсортированных по дате взятия. По другому: "Мои проекты".
- `/best` — выводит список из 10-ти никем не взятых проектов в порядке убывания лайков и в порядке убывания TSS. Не выводит проекты, добавленные менее 5 минут назад. По другому: "Сначала интересные".
- `/new` — выводит список из 10-ти никем не взятых проектов без оценок, отсортированных по новизне и в порядке убывания TSS. Не выводит проекты, добавленные менее 5 минут назад. По другому: "Сначала новые".
- `/set_username` — заносит Telegram Handle менеджера в базу. Теперь вместо Telegram ID на месте, где указывается менеджер, будет указан его Telegram Handle. Если менеджер изменил свой Telegram Handle, ему нужно снова ввести эту команду.

Команды для администраторов:
- `/help` — содержит в себе описания всех команд для менеджеров и администраторов.
- `/managers` — выводит список всех менеджеров и администраторов.
- `/add_manager [telegram_id]` — добавляет менеджера с указанным Telegram ID.
- `/delete_managers [telegram_id]` (`/delete_manager`) — удаляет менеджеров с указанными Telegram ID.
- `/delete_projects [twitter_handle]` (`/delete_project`) — удаляет проекты с указанными Twitter handle.
- (не реализовано) `/top_managers_day` — выводит список менеджеров в порядке убывания количества поставленных оценок за день.
- (не реализовано) `/top_managers_week` — выводит список менеджеров в порядке убывания количества поставленных оценок за неделю.
- (не реализовано) `/top_managers_month` — выводит список менеджеров в порядке убывания количества поставленных оценок за месяц.
- (не реализовано) `/download_excell` — возвращает базу данных в виде файла excell-таблицы.

## Проект
### Форматы вывода информации о проекте
Выводить информацию о проекте можно в двух форматах:
- Краткий формат
- Полный формат

В отличие от полного формата, краткий формат содержит лишь важную базовую информацию о проекте и умещается в одну строчку.

#### Краткий формат
Краткий формат вывода включает в себя лишь базовую информацию о проекте: 
- Оценка проекта.
- TSS проекта.
- Ссылка на твиттер проекта.
- Telegram handle ведущего.

Краткая информация о проекте должна умещаться в одну строчку.

Примеры вывода базовой информации о проекте без ведущего:
```
# ┏━ Лайки
# ┃  ┏━ Дизлайки
# ┃  ┃   ┏━ TSS
# ┃  ┃   ┃     ┏━ Затекстовая ссылка на твиттер проекта
# ┃  ┃   ┃     ┃                 ┏━ Никнейм ведущего
[+1/-0] (0227) TweetScout_io  -> @AlenKimov
#              |<- - - - - ->| Фиксированный размер в 15 символов
```

Если проект добавлен менее 5-ти минут назад, не имеет оценок и ведущего, то в информации о проекте на месте оценок будет плашка `NEW!`:
```
[NEW!] (0227) TweetScout_io
```

#### Полный формат
Полная формат вывода помимо базовой информации включает в себя следующие поля:
- Ссылка на дискорд проекта.
- Никнейм представителя в дискорде.

Пример вывода полной информации (базовая + дополнительная) о проекте:
```
[+1/-0] (0227) TweetScout_io  -> @AlenKimov
#        ┏━ Ссылка на дискорд
#        ┃                               ┏━ Никнейм представителя в дискорде
discord: https://discord.gg/uwAefKCj7X | keksich13#1242
```

### Меню работы с проектом
Для того чтобы открыть меню работы с проектом, нужно дропнуть в бота ссылку на твиттер проекта в любом из доступных форматов.

Бот вернет сообщение с полной информацией о проекте.

Бот предложит следующий выбор действий:
- **Лайк**
- **Дизлайк**
- **Стать ведущим**/**Отказаться от ведения**
Только, если он не бы взят до этого.
- **Запросить TSS** — запрашивает TSS через API TweetScout и присваивает его проекту.
> Можно поставить ограничение на 1 запрос на проект в день/час/минуту. Тогда в таблицу должно быть добавлено время последнего запроса.
- **Дискорд** — позволяет изменить ссылку на дискорд и ник админа проекта.

## Список проектов (не реализовано)
### Формат вывода
Список проектов выводится только в кратком формате:
```
[+1/-0] (5286) elonmusk       -> @AlenKimov
[+1/-0] (0227) TweetScout_io
[+0/-0] VitalikButerin
```

### Меню работы
- **Запросить TSS** — запрашивает TSS проектов из списка.
- **Пройтись по проектам** — позволяет пройтись по каждому из новых проектов по очереди. Это открывает особое меню работы с проектом с клавиатурой следующего содержания:
	- Верхний слой: 
		- Меню работы с проектом
	- Нижний слой:
		- **Назад** — возвращает к предыдущему проекту.
		- **Стоп** — возвращает к списку проектов.
		- **Вперед** — переходит к следующем проекту.

## Запрос и внесение проектов
**Дроп в бота** / **Запрос проекта(ов)** / **Внесение проекта(ов)** — отправка боту одной или нескольких ссылок на проект в любом из доступных форматов.

Если менеджер дропает один проект:
- Бот возвращает меню работы с проектом как для нового, так и для уже известного проекта.

Если менеджер дропает несколько проектов, то бот разбивает дроп на три списка:
- Проекты с ведущими:
```
[+1/-0] (5286) elonmusk       -> @AlenKimov
[+1/-0] (0227) TweetScout_io  -> @AlenKimov
[+0/-0] (0010) VitalikButerin -> @AlenKimov
```
- Проекты без ведущих:
```
[+0/-0] (5286) elonmusk
[+0/-0] (0227) TweetScout_io
[+0/-0] VitalikButerin
```
- Новые проекты:
```
[NEW!] (5286) elonmusk
[NEW!] (0227) TweetScout_io
[NEW!] VitalikButerin
```

## Ход реализации
Язык: Python 3.11
База данных: sqlite
Библиотеки:
	Телеграм: aiogram 3.0
	Логирование: loguru
	База данных: aiosqlite + SQLAlchemy 2.0 (ORM) + Alembic (Миграции)

- [ ] Переход на Poetry (`pyproject.toml`)
- [ ] Докер контейнеризация
- База данных
	- [x] Описание таблиц (`models.py`)
	- [x] Триггеры для подсчета оценок
	- [x] Асинхронность
	- [ ] Резервное копирование
	- [ ] Миграции Alembic
		- [ ] Миграции триггеров
- Telegram бот
	- [x] Меню бота
	- [x] Проверка роли
	- Возможности пользователя
		- [x] Команда `/start`
		- [x] Команда `/help`
	- Возможности менеджера
		- [x] Запрос и внесение проектов
		- [x] Команда `/help`
		- [x] Команда `/my`
		- [ ] Команда `/best`
		- [ ] Команда `/new`
		- [x] Команда `/set_username`
		- Меню работы с проектом
			- [x] **Поставить оценку**
			- [x] **Стать ведущим**/**Отказаться от ведения**
			- [x] **Запросить TSS**
			- [ ] **Дискорд**
	- Возможности администратора
		- [x] Команда `/help`
		- [x] Команда `/managers`
		- [x] Команда `/add_manager`
		- [x] Команда `/delete_managers`
		- [x] Команда `/delete_projects`
- Логирование
	- [x] Настройка loguru.
	- [x] [Перехват стандартного логгера python через loguru](https://loguru.readthedocs.io/en/stable/overview.html#entirely-compatible-with-standard-logging).
- utils
	- [x] Функция, которая принимает в себя ссылки на твиттера в любом из доступных форматов и возвращает либо Twitter Handle без @, либо `None`.
	- [ ] Функци, которая проверяет, является ли Twitter Handle проекта действительным через Twitter API.
	- [ ] Функция, запрашивающая Telegram Handle по Telegram ID.
- TweetScout API (aiots)
	- [x] Асинхронность
	- [x] Функция, которая принимает Twitter Handle проекта и возвращает его TSS. 
	- [ ] Должна вызываться не чаще установленной задержки. Задрежка нужна, чтобы не насиловать API TweetScout'а.
